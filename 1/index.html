<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DR.Xiaomi - Servicio T√©cnico</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #121212;
      --bg-secondary: #1a1a1a;
      --bg-tertiary: #2d2d2d;
      --text-primary: #f9fafb;
      --text-secondary: #9ca3af;
      --accent: #ff7b00;
      --accent-hover: #ff9a3d;
      --border: #374151;
      --success: #16a34a;
      --error: #f97373;
    }

    *{margin:0;padding:0;box-sizing:border-box}

    body{
      font-family:'Roboto',sans-serif;
      background: radial-gradient(circle at top, #1f2933 0, #020617 45%, #000 100%);
      color: var(--text-primary);
      display:flex;
      justify-content:center;
      padding:20px;
      min-height:100vh;
    }

    .container{
      width:100%;
      max-width:430px;
      background:var(--bg-primary);
      border-radius:24px;
      box-shadow:0 20px 40px rgba(0,0,0,0.6),
                 0 0 0 1px rgba(148,163,184,0.15);
      overflow:hidden;
    }

    header{
      background:rgba(15,23,42,0.95);
      padding:14px 16px;
      text-align:center;
      border-bottom:1px solid rgba(148,163,184,0.3);
    }

    header h1{
      color:var(--accent);
      font-size:18px;
      margin:0;
      letter-spacing:0.06em;
    }

    main{
      padding:16px 14px 18px;
      background:var(--bg-primary);
    }

    fieldset{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px 10px;
      margin-bottom:14px;
      background:var(--bg-secondary);
    }

    legend{
      padding:0 8px;
      font-weight:600;
      color:var(--text-primary);
      font-size:13px;
    }

    label{
      display:block;
      margin-top:8px;
      color:var(--text-secondary);
      font-size:13px;
    }

    input,select,textarea,button{
      width:100%;
      font-size:14px;
    }

    input,select,textarea{
      padding:8px 10px;
      margin-top:4px;
      border:1px solid var(--border);
      border-radius:10px;
      background:var(--bg-tertiary);
      color:var(--text-primary);
    }

    input::placeholder,
    textarea::placeholder{
      color:#6b7280;
      font-size:13px;
    }

    button{
      padding:12px;
      background:var(--accent);
      color:#fff;
      border:none;
      border-radius:999px;
      cursor:pointer;
      margin-top:16px;
      font-weight:600;
      letter-spacing:0.03em;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      box-shadow:0 8px 20px rgba(255,123,0,0.35);
      transition:all 0.25s ease;
    }

    button:hover{
      background:var(--accent-hover);
      transform:translateY(-1px);
      box-shadow:0 12px 26px rgba(255,123,0,0.4);
    }

    .button-icon{
      font-size:16px;
    }

    .date-container{
      margin-bottom:8px;
      text-align:right;
      color:var(--text-secondary);
      font-size:11px;
    }

    #pattern-container{
      position:relative;
      width:100%;
      height:220px;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--bg-primary);
      margin-top:8px;
      overflow:hidden;
    }

    #pattern-container canvas{
      position:absolute;
      top:0;
      left:0;
      width:100%;
      height:100%;
    }

    #pattern-sequence{
      margin-top:8px;
      text-align:center;
      color:var(--text-secondary);
      font-size:13px;
    }

    #imagePreview{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }

    .preview-image{
      width:80px;
      height:80px;
      object-fit:cover;
      border-radius:10px;
      border:1px solid var(--border);
    }

    #photoCounter{
      font-size:11px;
      color:var(--text-secondary);
      margin-top:4px;
    }

    #confirmation{
      display:none;
      background:rgba(22,163,74,0.15);
      color:#bbf7d0;
      padding:10px 12px;
      border-radius:999px;
      margin-top:12px;
      text-align:center;
      font-size:12px;
      border:1px solid rgba(34,197,94,0.5);
    }

    .costos-container{
      display:flex;
      gap:12px;
      margin-top:12px;
    }

    .costo-box{
      flex:1;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      background:var(--bg-tertiary);
    }

    .costo-box label{
      font-weight:600;
      color:var(--text-secondary);
      font-size:12px;
    }

    .costo-box input{
      text-align:right;
      font-weight:600;
      border:none;
      background:transparent;
      color:var(--text-primary);
      margin-top:6px;
      font-size:15px;
    }

    .servicios-container{margin-top:10px;}

    .servicio-item{
      display:flex;
      gap:8px;
      margin-bottom:8px;
      align-items:center;
    }

    .servicio-item input{
      flex:3;
    }

    .servicio-item input[type="number"]{
      flex:1.2;
      text-align:right;
    }

    .servicio-item button{
      flex:0 0 34px;
      margin-top:0;
      padding:6px 0;
      border-radius:999px;
      background:var(--bg-tertiary);
      box-shadow:none;
      color:var(--text-secondary);
    }

    .servicio-item button:hover{
      background:#7f1d1d;
      color:#fecaca;
      box-shadow:0 0 0 1px rgba(248,113,113,0.6);
      transform:none;
    }

    #addServicio{
      background:#2563eb;
      box-shadow:0 8px 18px rgba(37,99,235,0.35);
      width:auto;
      padding-inline:14px;
      font-size:13px;
    }

    #addServicio:hover{
      background:#1d4ed8;
    }

    input:focus,select:focus,textarea:focus{
      border-color:var(--accent);
      outline:none;
      box-shadow:0 0 0 1px rgba(255,123,0,0.6);
    }

    .required-field::after{
      content:" *";
      color:#f97373;
    }

    #loading{
      display:none;
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.6);
      z-index:1000;
      justify-content:center;
      align-items:center;
    }

    #loading div{
      background:var(--bg-secondary);
      padding:20px 24px;
      border-radius:16px;
      text-align:center;
      color:var(--text-primary);
      border:1px solid var(--border);
      box-shadow:0 18px 40px rgba(0,0,0,0.8);
      font-size:13px;
    }

    .spinner{
      border:4px solid #1f2937;
      border-top:4px solid var(--accent);
      border-radius:50%;
      width:30px;
      height:30px;
      animation:spin 1s linear infinite;
      margin:0 auto 10px;
    }

    @keyframes spin{
      0%{transform:rotate(0deg)}
      100%{transform:rotate(360deg)}
    }

    @media(max-width:480px){
      body{padding:10px;}
      .container{border-radius:0;max-width:100%;box-shadow:none;}
      header h1{font-size:16px;}
      label{font-size:12px;}
      .servicio-item{flex-direction:column;align-items:stretch;}
      .servicio-item button{align-self:flex-end;}
      .costos-container{flex-direction:column;}
    }
  </style>
</head>
<body>
  <div class="container">
    <header><h1>RECIBO DR:XIAOMI</h1></header>
    <main>
      <form id="formRecibo">
        <fieldset>
          <legend>Datos del Cliente</legend>
          <div class="date-container">
            <span id="dateTimeDisplay"></span>
            <span id="numeroReciboDisplay" style="margin-left:10px;"></span>
          </div>
          <label class="required-field">Nombre</label>
          <input type="text" id="nombre" required placeholder="Ej: Juan P√©rez">
          <label class="required-field">Tel√©fono</label>
          <input type="tel" id="telefono" required placeholder="Ej: 75522004" pattern="[0-9]{7,8}">
        </fieldset>

        <fieldset>
          <legend>Dispositivo</legend>
          <label class="required-field">Marca</label>
          <select id="marca" required>
            <option value="">Seleccionar</option>
            <option>Xiaomi</option>
            <option>Samsung</option>
            <option>Huawei</option>
            <option>Tecno</option>
            <option>Honor</option>
            <option>Infinix</option>
            <option>iPhone</option>
          </select>

          <label class="required-field">Modelo</label>
          <input type="text" id="modelo" required placeholder="Ej: Redmi Note 10">

          <label>IMEI/Serial (opcional)</label>
          <input type="text" id="imei" placeholder="15 d√≠gitos">

          <label class="required-field">¬øEnciende?</label>
          <select id="enciende" required>
            <option value="">Seleccionar</option>
            <option>S√≠</option>
            <option>No</option>
            <option>A veces</option>
          </select>
        </fieldset>

        <fieldset>
          <legend>Estado y Falla</legend>
          <label>Estado del equipo</label>
          <textarea id="estado" rows="2" placeholder="Describa el estado f√≠sico del equipo"></textarea>
          <label>Falla reportada</label>
          <textarea id="falla" rows="2" placeholder="Describa la falla que presenta el equipo"></textarea>
        </fieldset>

        <fieldset>
          <legend>Seguridad</legend>
          <label>Tipo</label>
          <select id="tipoSeguridad">
            <option value="patron">Patr√≥n</option>
            <option value="pin">PIN</option>
            <option value="ninguno">Ninguno</option>
          </select>
          <div id="pinContainer" style="display:none;margin-top:8px">
            <label>PIN</label>
            <input type="password" id="pinInput" maxlength="6" placeholder="6 d√≠gitos">
          </div>
        </fieldset>

        <fieldset id="field-patron">
          <legend>Patr√≥n</legend>
          <div id="pattern-container">
            <canvas id="bgCanvas" width="300" height="220"></canvas>
            <canvas id="lineCanvas" width="300" height="220"></canvas>
          </div>
          <div id="pattern-sequence">Secuencia: ‚Äì</div>
        </fieldset>

        <fieldset>
          <legend>Fotos (m√°x.4)</legend>
          <input type="file" id="fotos" accept="image/*" multiple>
          <div id="photoCounter">0/4 fotos seleccionadas</div>
          <div id="imagePreview"></div>
        </fieldset>
        
        <fieldset>
          <legend>Servicios y Costos (Bs.)</legend>
          <div class="servicios-container" id="serviciosList">
            <div class="servicio-item">
              <input type="text" class="servicio-desc" placeholder="Descripci√≥n del servicio">
              <input type="number" class="servicio-costo" placeholder="Bs. 0.00" step="0.01" min="0">
              <button type="button" class="removeServicio" style="display:none">√ó</button>
            </div>
          </div>
          <button type="button" id="addServicio">+ A√±adir otro servicio</button>
          
          <div class="costos-container">
            <div class="costo-box">
              <label>Costo total</label>
              <input type="number" id="costoTotal" placeholder="Bs. 0.00" readonly>
            </div>
          </div>
        </fieldset>
        
        <input type="hidden" id="patternValue">
        <div id="confirmation">Recibo generado con √©xito!</div>
        <button type="submit" id="generateBtn">
          <span class="button-icon">üìÑ</span>
          Generar Recibo PDF
        </button>
      </form>
    </main>
  </div>
  
  <div id="loading">
    <div>
      <div class="spinner"></div>
      <p>Generando recibo...</p>
    </div>
  </div>

  <script>
    // Contador de recibos persistentedocument.addEventListener('DOMContentLoaded', () => {
  // Funci√≥n para actualizar la hora en formato AM/PM
  function formatAMPM(date) {
    let hours = date.getHours();
    let minutes = date.getMinutes();
    let ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12; // El 0 se convierte en 12
    minutes = minutes < 10 ? '0' + minutes : minutes;
    return hours + ':' + minutes + ' ' + ampm;
  }

  // Generar PDF innovador con color naranja
  document.getElementById('formRecibo').addEventListener('submit', async e => {
    e.preventDefault();

    const form = document.getElementById('formRecibo');
    if (!form.checkValidity()) {
      alert('Por favor complete todos los campos requeridos');
      return;
    }

    // Validar que haya al menos un servicio con descripci√≥n o costo > 0
    const servicios = Array.from(document.querySelectorAll('.servicio-item'));
    const hayServicioValido = servicios.some(item => {
      const desc = item.querySelector('.servicio-desc').value.trim();
      const costo = parseFloat(item.querySelector('.servicio-costo').value) || 0;
      return desc !== '' || costo > 0;
    });

    if (!hayServicioValido) {
      alert('Agrega al menos un servicio con descripci√≥n o costo mayor a 0.');
      return;
    }

    const loading = document.getElementById('loading');
    loading.style.display = 'flex';

    try {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit: 'mm', format: 'a4' });

      // ====== DATOS B√ÅSICOS ======
      const fecha = new Date();
      const nombreCompleto = document.getElementById('nombre').value.trim();
      const nombreCliente = nombreCompleto.split(' ')[0] || 'Cliente';
      const telefono = document.getElementById('telefono').value;
      const marca = document.getElementById('marca').value;
      const modelo = document.getElementById('modelo').value;
      const imei = document.getElementById('imei').value;
      const enciende = document.getElementById('enciende').value;
      const estado = document.getElementById('estado').value || '-';
      const falla = document.getElementById('falla').value || '-';
      const tipoSeguridad = document.getElementById('tipoSeguridad').value;
      const pin = document.getElementById('pinInput').value || '-';
      const patron = document.getElementById('patternValue').value || '-';

      // N√∫mero de recibo consistente + guardado
      contadorRecibos++;
      localStorage.setItem('contadorRecibos', contadorRecibos);
      const numeroRecibo = `REC-${contadorRecibos}`;

      // ====== FUENTE GENERAL ======
      pdf.setFont('courier', 'normal');
      pdf.setFontSize(9);
      pdf.setTextColor(0);

      let y = 10;
      const marginLeft = 15;
      const centerX = 105;
      const colorNaranja = [255, 152, 0];  // Color naranja vibrante

      // ====== ENCABEZADO TIENDA ======
      pdf.setFontSize(14);
      pdf.setTextColor(...colorNaranja);
      pdf.text(config.nombreTienda, centerX, y + 5, { align: 'center' });

      pdf.setFontSize(8);
      pdf.setTextColor(100);
      pdf.text(config.direccion, centerX, y + 9, { align: 'center' });
      pdf.text(`Tel: ${config.telefono} ¬∑ ${config.horario}`, centerX, y + 13, { align: 'center' });

      pdf.setDrawColor(...colorNaranja);
      pdf.line(20, y + 16, 190, y + 16);

      // ====== T√çTULO ======
      y += 24;
      pdf.setFontSize(11);
      pdf.setTextColor(0);
      pdf.setFont('courier', 'bold');
      pdf.text('RECIBO DE SERVICIO T√âCNICO', centerX, y, { align: 'center' });

      // N√∫mero y fecha con formato AM/PM
      y += 6;
      pdf.setFontSize(8);
      pdf.setFont('courier', 'normal');
      pdf.text(`N¬∞ Recibo: ${numeroRecibo}`, marginLeft, y);
      pdf.text(
        `Fecha: ${fecha.toLocaleDateString()} ${formatAMPM(fecha)}`,
        200 - marginLeft,
        y,
        { align: 'right' }
      );

      // ====== DATOS DEL CLIENTE ======
      y += 8;
      pdf.setFont('courier', 'bold');
      pdf.text('DATOS DEL CLIENTE', marginLeft, y);
      pdf.setDrawColor(200);
      pdf.line(marginLeft, y + 1, 195, y + 1);

      y += 5;
      pdf.setFont('courier', 'normal');
      pdf.setFontSize(9);
      pdf.text(`Nombre: ${nombreCompleto}`, marginLeft, y);
      y += 5;
      pdf.text(`Tel√©fono: `, marginLeft, y);
      pdf.text(
        `wa.me/591${telefono}`,
        200 - marginLeft,
        y,
        { align: 'right', link: `https://wa.me/591${telefono}` }
      );

      // ====== DATOS DEL EQUIPO ======
      y += 8;
      pdf.setFont('courier', 'bold');
      pdf.text('DATOS DEL EQUIPO', marginLeft, y);
      pdf.setDrawColor(200);
      pdf.line(marginLeft, y + 1, 195, y + 1);

      pdf.setFont('courier', 'normal');
      y += 5;
      pdf.text(`Marca: ${marca}`, marginLeft, y);
      y += 5;
      pdf.text(`Modelo: ${modelo}`, marginLeft, y);
      y += 5;
      pdf.text(`¬øEnciende?: ${enciende}`, marginLeft, y);
      if (imei) {
        y += 5;
        pdf.text(`IMEI/Serial: ${imei}`, marginLeft, y);
      }

      // ====== ESTADO Y FALLA ======
      y += 8;
      pdf.setFont('courier', 'bold');
      pdf.text('ESTADO Y FALLA', marginLeft, y);
      pdf.setDrawColor(200);
      pdf.line(marginLeft, y + 1, 195, y + 1);

      pdf.setFont('courier', 'normal');
      y += 5;
      pdf.text(`Estado: ${estado}`, marginLeft, y);
      y += 5;
      pdf.text(`Falla reportada: ${falla}`, marginLeft, y);

      // ====== SERVICIOS ======
      y += 8;
      pdf.setFont('courier', 'bold');
      pdf.text('SERVICIOS Y COSTOS (Bs.)', marginLeft, y);
      pdf.setDrawColor(200);
      pdf.line(marginLeft, y + 1, 195, y + 1);

      const serviciosData = [];
      document.querySelectorAll('.servicio-item').forEach(item => {
        const desc = item.querySelector('.servicio-desc').value || '-';
        const costo = parseFloat(item.querySelector('.servicio-costo').value) || 0;
        serviciosData.push([desc, `Bs. ${costo.toFixed(2)}`]);
      });

      pdf.autoTable({
        startY: y + 4,
        head: [['Descripci√≥n', 'Costo (Bs.)']],
        body: serviciosData,
        styles: { fontSize: 8, font: 'courier' },
        headStyles: { fillColor: colorNaranja, textColor: 255 },
        columnStyles: {
          0: { cellWidth: 120 },
          1: { halign: 'right' }
        },
        margin: { left: marginLeft, right: 15 }
      });

      y = pdf.autoTable.previous.finalY + 4;

      const total = parseFloat(document.getElementById('costoTotal').value) || 0;
      pdf.setFont('courier', 'bold');
      pdf.setFontSize(10);
      pdf.setDrawColor(...colorNaranja);
      pdf.setFillColor(255, 250, 240);

      pdf.roundedRect(120, y - 4, 70, 8, 2, 2, 'FD');
      pdf.text(`TOTAL: Bs. ${total.toFixed(2)}`, 155, y + 1, { align: 'center' });

      // ====== IM√ÅGENES ======
      const files = document.getElementById('fotos').files;
      if (files.length > 0) {
        y += 10;
        pdf.setFont('courier', 'bold');
        pdf.text('IM√ÅGENES DEL EQUIPO', marginLeft, y);
        pdf.setDrawColor(200);
        pdf.line(marginLeft, y + 1, 195, y + 1);

        let xImg = marginLeft;
        let yImg = y + 4;

        for (let i = 0; i < Math.min(files.length, 4); i++) {
          const file = files[i];
          const imageData = await new Promise(res => {
            const r = new FileReader();
            r.onload = e2 => res(e2.target.result);
            r.readAsDataURL(file);
          });

          if (yImg > 230) {
            pdf.addPage();
            yImg = 20;
            xImg = marginLeft;
          }

          pdf.addImage(imageData, 'JPEG', xImg, yImg, 80, 40);

          if (i % 2 === 0) {
            xImg += 90;
          } else {
            xImg = marginLeft;
            yImg += 45;
          }
        }

        y = yImg + 50;
      } else {
        y += 8;
      }

      // ====== CONDICIONES ======
      pdf.setFont('courier', 'bold');
      pdf.setFontSize(9);
      pdf.text('CONDICIONES DEL SERVICIO', marginLeft, y);
      pdf.setDrawColor(200);
      pdf.line(marginLeft, y + 1, 195, y + 1);

      pdf.setFont('courier', 'normal');
      pdf.setFontSize(7);
      y += 5;

      const condiciones = [
        '1. Conserve este recibo; solo con √©l puede retirar su equipo.',
        '2. La fecha de entrega est√° sujeta a disponibilidad de repuestos.',
        '3. El retiro debe hacerse Max dentro de los 10 d√≠as posteriores al aviso.',
        '4. Pasados 20 d√≠as sin retiro, el equipo se considera abandonado.',
        '5. Garant√≠a: 30 d√≠as en repuesto / 60 d√≠as en mano de obra.'
      ];

      condiciones.forEach((txt, i) => {
        pdf.text(txt, marginLeft, y + i * 4);
      });

      pdf.setFontSize(7);
      pdf.setTextColor(120);
      pdf.text(
        `¬© ${fecha.getFullYear()} ${config.nombreTienda} ¬∑ Todos los derechos reservados`,
        centerX,
        287,
        { align: 'center' }
      );

      pdf.save(`Recibo_${numeroRecibo}_${nombreCliente}.pdf`);

      const confirmation = document.getElementById('confirmation');
      confirmation.textContent = `Recibo ${numeroRecibo} generado con √©xito!`;
      confirmation.style.display = 'block';
      setTimeout(() => (confirmation.style.display = 'none'), 4000);

    } catch (err) {
      alert('Error al generar PDF: ' + err.message);
    } finally {
      loading.style.display = 'none';
    }
  });
});
  </script>
</body>
</html>
