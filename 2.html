<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#121212" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="description" content="Dr. Xiaomi - Gesti√≥n de precios de pantallas" />
  <title>Dr. Xiaomi</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    :root {
      --primary-bg: #2e3b4e;
      --secondary-bg: #1a2430;
      --accent-color: #ff8c00;
      --text-color: #f1f1f1;
      --highlight-color: #4caf50;
      --error-color: #f44336;
      --border-radius: 10px;
      --box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--primary-bg);
      color: var(--text-color);
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      transition: background-color 0.3s ease;
    }

    h1, h2, h3 {
      font-family: 'Roboto', sans-serif;
      color: var(--accent-color);
    }

    button {
      background-color: var(--accent-color);
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    button:hover {
      background-color: #e66a00;
    }

    .search-box input[type="text"] {
      width: 100%;
      padding: 12px;
      background-color: var(--secondary-bg);
      color: var(--text-color);
      border: 1px solid #333;
      border-radius: var(--border-radius);
      transition: all 0.3s ease;
    }

    .search-box input[type="text"]:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 10px rgba(255, 123, 0, 0.2);
    }

    .table-container {
      overflow-x: auto;
      margin: 20px 0;
      background-color: var(--secondary-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px;
      text-align: left;
      color: var(--text-color);
    }

    th {
      background-color: #444;
      border-bottom: 2px solid var(--border-color);
      font-size: 16px;
      font-weight: bold;
    }

    tr:nth-child(even) {
      background-color: #333;
    }

    tr:hover {
      background-color: var(--highlight-color);
    }

    td input[type="text"] {
      background-color: transparent;
      border: 1px solid #555;
      color: var(--text-color);
      padding: 6px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    td input[type="text"]:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 10px rgba(255, 123, 0, 0.3);
    }

    .modal-content {
      background-color: var(--secondary-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    .modal-content h2 {
      color: var(--accent-color);
    }

    .status {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--secondary-bg);
      padding: 10px 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      color: var(--text-color);
      font-weight: bold;
      display: none;
    }

    .status.success {
      background-color: #4caf50;
    }

    .status.error {
      background-color: #f44336;
    }

    .status.info {
      background-color: #2196f3;
    }
  </style>
</head>

<body>
  <div class="app-container">
    <header class="app-header">
      <div class="header-content">
        <div class="app-title">
          <div class="app-icon"><i class="fas fa-mobile-alt"></i></div>
          <h1>DR. XIAOMI</h1>
        </div>

        <div class="admin-access">
          <button class="admin-toggle" id="providersBtn" title="Modo t√©cnico (ver datos bloqueados)">
            <span class="toggle-label">T√©cnico</span>
            <span class="toggle-pill"><span class="toggle-circle"></span></span>
          </button>

          <a href="http://xiaomi.scz.red/1/" class="admin-btn receipt-btn" id="receiptBtn" title="Recibo">
            <i class="fas fa-receipt"></i>
          </a>

          <button class="theme-toggle admin-btn" id="themeToggle" title="Cambiar tema">
            <i class="fas fa-sun"></i>
          </button>
        </div>
      </div>

      <div class="subtitle">
        Sistema de gesti√≥n de precios ¬∑ <span id="lastUpdate">‚Äî</span>
      </div>
    </header>

    <section class="search-section">
      <div id="editNotice" class="edit-notice" style="display:none;">
        <i class="fas fa-edit"></i>
        <strong>Modo Edici√≥n Activado</strong> - Puedes editar precios directamente en la tabla
      </div>

      <div class="search-controls">
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Buscar marca, modelo, tipo o proveedor..." />
          <div class="search-icon"><i class="fas fa-search"></i></div>
        </div>
      </div>
    </section>

    <main class="main-content">
      <div id="statusMessage" class="status"></div>
      <div id="resultsCount" class="results-count"></div>

      <div class="table-container">
        <table id="resultsTable">
          <thead>
            <tr>
              <th data-column="marca" class="col-marca">Marca</th>
              <th data-column="modelo" class="col-modelo">Modelo</th>
              <th data-column="tipo" class="col-tipo">Tipo</th>
              <th data-column="proveedor" class="col-proveedor">Prov.</th>
              <th data-column="precio_compra" class="col-compra">Compra</th>
              <th data-column="precio_venta" class="col-venta">Venta</th>
            </tr>
          </thead>
          <tbody id="resultsBody"></tbody>
        </table>
      </div>
    </main>

    <nav class="bottom-nav">
      <div class="nav-item active" data-tab="main">
        <div class="nav-icon"><i class="fas fa-home"></i></div>
        <div class="nav-label">Inicio</div>
      </div>

      <div class="nav-item" data-tab="favorites">
        <div class="nav-icon"><i class="fas fa-star"></i></div>
        <div class="nav-label">TIKTOK</div>
      </div>

      <a href="http://xiaomi.scz.red/1/" class="nav-item" data-tab="compare">
        <div class="nav-icon"><i class="fas fa-balance-scale"></i></div>
        <div class="nav-label">Recibo</div>
      </a>
    </nav>
  </div>

  <script>
    const CONFIG = [
      { nombre: "J&A", archivo: "https://xiaomi.scz.red/precio/data/ja2.csv" },
      { nombre: "CentralCell", archivo: "https://xiaomi.scz.red/precio/data/centralcel.csv" },
      { nombre: "Osmobil", archivo: "https://xiaomi.scz.red/precio/data/osmobil.csv" },
      { nombre: "CFH LP", archivo: "https://xiaomi.scz.red/precio/data/CFH.csv" },
      { nombre: "BITE", archivo: "https://xiaomi.scz.red/precio/data/boe.csv" }
    ];

    const ADMIN_PASSWORD = "123456";
    const EDIT_PASSWORD = "123456";
    const VENTA_PASSWORD = "123456";
    const PROVIDERS_PASSWORD = "123456";

    let allData = [];
    let filteredData = [];

    // ‚úÖ por defecto: mejor precio primero (compra si hay acceso, si no -> venta)
    let sortColumn = "precio_compra";
    let sortDirection = "asc";

    let searchTerm = "";
    let showProviders = false;      // solo afecta UI del toggle (no recorta lista)
    let editMode = false;
    let ventaEditMode = false;
    let providersAccess = false;

    let currentWhatsappRow = null;
    let comparingItems = new Set();
    let currentTab = "main";
    let isLightMode = false;

    document.addEventListener("DOMContentLoaded", function () {
      initializeApp();
    });

    function initializeApp() {
      loadAllData();
      setupEventListeners();
      updateProvidersUI();
      updateTableColumns();
      checkOnlineStatus();
      updateLastUpdateLabel();
      registerServiceWorker();

      const savedTheme = localStorage.getItem("themePreference");
      if (savedTheme === "light") toggleTheme();
    }

    function updateLastUpdateLabel() {
      const el = document.getElementById("lastUpdate");
      if (!el) return;
      const hoy = new Date();
      el.textContent = hoy.toLocaleDateString("es-BO", { day: "2-digit", month: "2-digit", year: "2-digit" });
    }

    function registerServiceWorker() {
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("./sw.js").catch(err => console.log("Service Worker error:", err));
      }
    }

    function setupEventListeners() {
      const searchInput = document.getElementById("searchInput");
      searchInput.addEventListener("input", debounce(handleSearch, 250));

      const providersBtn = document.getElementById("providersBtn");
      if (providersBtn) providersBtn.addEventListener("click", handleProvidersButtonClick);

      document.getElementById("themeToggle").addEventListener("click", toggleTheme);

      setupModalEvents();

      document.querySelectorAll(".nav-item").forEach(item => item.addEventListener("click", handleNavigation));

      document.addEventListener("keydown", handleKeyboardShortcuts);
      window.addEventListener("online", handleOnlineStatus);
      window.addEventListener("offline", handleOnlineStatus);

      document.querySelectorAll('th[data-column]').forEach(th => {
        th.addEventListener("click", () => sortTable(th.getAttribute("data-column")));
      });
    }

    function toggleTheme() {
      isLightMode = !isLightMode;
      const toggleIcon = document.querySelector("#themeToggle i");
      if (isLightMode) {
        document.body.classList.add("light-mode");
        if (toggleIcon) toggleIcon.className = "fas fa-moon";
        localStorage.setItem("themePreference", "light");
      } else {
        document.body.classList.remove("light-mode");
        if (toggleIcon) toggleIcon.className = "fas fa-sun";
        localStorage.setItem("themePreference", "dark");
      }
    }

    async function loadAllData() {
      showStatus("üîÑ Cargando datos desde archivos CSV...", "info");
      try {
        allData = [];
        let loadedCount = 0;
        let totalRecords = 0;

        for (const provider of CONFIG) {
          try {
            const data = await loadCSVData(provider.archivo, provider.nombre);
            allData = [...allData, ...data];
            loadedCount++;
            totalRecords += data.length;
          } catch (error) {
            console.error(`Error cargando datos de ${provider.nombre}:`, error);
          }
        }

        const storedData = localStorage.getItem("customPriceData");
        if (storedData) {
          try {
            const customData = JSON.parse(storedData);
            allData = [...allData, ...customData];
          } catch (e) {
            console.error("Error cargando datos personalizados:", e);
          }
        }

        loadEditsFromStorage();
        verifyDataIntegrity();
        applyFilters();

        showStatus(`‚úÖ ${totalRecords} precios cargados de ${loadedCount} proveedores`, "success");
      } catch (error) {
        console.error("Error cargando datos:", error);
        showStatus("‚ùå Error cargando datos. Verifique la conexi√≥n.", "error");
      }
    }

    async function loadCSVData(filePath, providerName) {
      try {
        const response = await fetch(filePath);
        if (!response.ok) throw new Error(`Error ${response.status}`);
        const csvText = await response.text();
        const data = parseCSVCorregido(csvText, providerName);
        localStorage.setItem(`backup_${providerName}`, JSON.stringify(data));
        return data;
      } catch (error) {
        console.error(`Error cargando ${filePath}:`, error);
        const backupData = localStorage.getItem(`backup_${providerName}`);
        if (backupData) return JSON.parse(backupData);
        return [];
      }
    }

    function parseCSVCorregido(csvText, providerName) {
      const lines = csvText.split("\n").filter(line => line.trim() !== "");
      const data = [];
      if (lines.length === 0) return [];

      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue;

        const columns = parseCSVLine(line);

        if (columns.length >= 6) {
          const marca = columns[0] || "Desconocido";
          const modelo = columns[1] || "Desconocido";
          const tipo = (columns[2] || "LCD").toUpperCase();
          const proveedor = columns[3] || providerName;
          const precio_compra = parsePrice(columns[4]);
          const precio_venta = parsePrice(columns[5]);

          const row = {
            lista: providerName,
            marca: marca.trim(),
            modelo: modelo.trim(),
            tipo: tipo.trim(),
            proveedor: proveedor.trim(),
            precio_compra,
            precio_venta
          };

          if (row.marca !== "Desconocido" && row.modelo !== "Desconocido") data.push(row);
        } else if (columns.length === 5) {
          const marca = columns[0] || "Desconocido";
          const modelo = columns[1] || "Desconocido";
          const tipo = (columns[2] || "LCD").toUpperCase();
          const precio_compra = parsePrice(columns[3]);
          const precio_venta = parsePrice(columns[4]);

          const row = {
            lista: providerName,
            marca: marca.trim(),
            modelo: modelo.trim(),
            tipo: tipo.trim(),
            proveedor: providerName,
            precio_compra,
            precio_venta
          };
          data.push(row);
        }
      }
      return data;
    }

    function parseCSVLine(line) {
      const result = [];
      let current = "";
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') inQuotes = !inQuotes;
        else if (char === "," && !inQuotes) { result.push(current.trim()); current = ""; }
        else current += char;
      }
      result.push(current.trim());
      return result.map(field => field.replace(/^"|"$/g, ""));
    }

    function parsePrice(priceStr) {
      if (!priceStr || priceStr.trim() === "") return 0;

      let str = priceStr.toString().trim();
      str = str.replace(/[^\d.,-]/g, "");

      const isNegative = str.startsWith("-");
      if (isNegative) str = str.substring(1);

      const lastComma = str.lastIndexOf(",");
      const lastDot = str.lastIndexOf(".");

      let cleaned;
      if (lastComma > lastDot) cleaned = str.replace(/\./g, "").replace(",", ".");
      else cleaned = str.replace(/,/g, "");

      const num = parseFloat(cleaned);
      if (isNaN(num)) return 0;
      const rounded = Math.round(num);
      return isNegative ? -rounded : rounded;
    }

    // ===== PROVEEDORES (interruptor modo t√©cnico) =====
    function handleProvidersButtonClick() {
      if (!providersAccess) {
        showProvidersModal();
        return;
      }
      // Ahora SOLO cambia el estado visual (y columnas), no recorta data.
      showProviders = !showProviders;
      updateProvidersUI();
      applyFilters();
    }

    function updateProvidersUI() {
      const btn = document.getElementById("providersBtn");
      if (!btn) return;

      if (!providersAccess) {
        btn.classList.remove("on");
        btn.title = "Modo t√©cnico bloqueado (requiere clave)";
      } else {
        btn.classList.toggle("on", showProviders);
        btn.title = showProviders
          ? "Modo t√©cnico activo: mostrando importadoras y precios de compra"
          : "Modo t√©cnico desactivado";
      }
    }

    function updateTableColumns() {
      const tableContainer = document.querySelector(".table-container");
      if (!tableContainer) return;
      if (!providersAccess) tableContainer.classList.add("hide-columns");
      else tableContainer.classList.remove("hide-columns");
    }

    function toggleFavorite(row) {
      const favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
      const itemId = generateRowId(row);

      if (favorites.includes(itemId)) {
        favorites.splice(favorites.indexOf(itemId), 1);
        showStatus("‚ù§Ô∏è Eliminado de favoritos", "info");
      } else {
        favorites.push(itemId);
        showStatus("‚≠ê Agregado a favoritos", "success");
      }
      localStorage.setItem("favorites", JSON.stringify(favorites));
    }

    function toggleCompare(row) {
      const itemId = generateRowId(row);
      if (comparingItems.has(itemId)) {
        comparingItems.delete(itemId);
        showStatus("üìä Eliminado de comparaci√≥n", "info");
      } else {
        if (comparingItems.size >= 4) {
          showStatus("‚ùå M√°ximo 4 productos para comparar", "error");
          return;
        }
        comparingItems.add(itemId);
        showStatus("üìä Agregado a comparaci√≥n", "success");
      }
    }

    function showCompareModal() {
      const compareResults = document.getElementById("compareResults");
      compareResults.innerHTML = "";

      if (comparingItems.size === 0) {
        compareResults.innerHTML = '<p style="text-align:center;color:var(--text-secondary);">No hay productos para comparar</p>';
      } else {
        const itemsToCompare = allData.filter(row => comparingItems.has(generateRowId(row)));
        let compareHTML = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">';

        itemsToCompare.forEach(item => {
          compareHTML += `
            <div style="background:var(--bg-primary);padding:12px;border-radius:10px;border:1px solid var(--border);">
              <h4 style="color:var(--accent);margin-bottom:6px;font-size:0.9rem;">
                ${item.marca} ${item.modelo}
              </h4>
              <p style="font-size:0.8rem;"><strong>Tipo:</strong> ${item.tipo}</p>
              <p style="font-size:0.8rem;"><strong>Proveedor:</strong> ${item.proveedor}</p>
              <p style="font-size:0.8rem;"><strong>Compra:</strong> Bs. ${formatCurrency(item.precio_compra)}</p>
              <p style="font-size:0.8rem;"><strong>Venta:</strong> Bs. ${formatCurrency(item.precio_venta)}</p>
            </div>
          `;
        });

        compareHTML += "</div>";
        compareResults.innerHTML = compareHTML;
      }

      document.getElementById("compareModal").style.display = "flex";
    }

    function clearCompare() {
      comparingItems.clear();
      hideCompareModal();
      showStatus("üóëÔ∏è Comparaci√≥n limpiada", "success");
    }

    function exportToCSV() {
      const headers = ["Marca", "Modelo", "Tipo", "Proveedor", "Precio Compra", "Precio Venta"];
      const csvContent = [
        headers.join(","),
        ...filteredData.map(row =>
          [
            `"${row.marca}"`,
            `"${row.modelo}"`,
            `"${row.tipo}"`,
            `"${row.proveedor}"`,
            row.precio_compra,
            row.precio_venta
          ].join(",")
        )
      ].join("\n");

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `precios_pantallas_${new Date().toISOString().split("T")[0]}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showStatus("üì§ Datos exportados correctamente", "success");
    }

    function checkOnlineStatus() {
      if (!navigator.onLine) showStatus("‚ö†Ô∏è Est√°s trabajando en modo offline", "warning");
    }
    function handleOnlineStatus() {
      if (navigator.onLine) showStatus("‚úÖ Conexi√≥n restaurada", "success");
      else showStatus("‚ö†Ô∏è Modo offline activado", "warning");
    }

    function handleNavigation(event) {
      const tab = event.currentTarget.getAttribute("data-tab");
      document.querySelectorAll(".nav-item").forEach(item => item.classList.remove("active"));
      event.currentTarget.classList.add("active");
      currentTab = tab;

      switch (tab) {
        case "favorites":
          showFavorites();
          break;
        case "compare":
          showCompareModal();
          break;
        default:
          applyFilters();
          break;
      }
    }

    function showFavorites() {
      const favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
      filteredData = allData.filter(row => favorites.includes(generateRowId(row)));
      // ordena igual por mejor precio
      const effectiveSortColumn = (!providersAccess && sortColumn === "precio_compra") ? "precio_venta" : sortColumn;
      sortData(filteredData, effectiveSortColumn, sortDirection);
      renderTable();
      updateResultsCount();
    }

    function handleKeyboardShortcuts(event) {
      if (event.ctrlKey || event.metaKey) {
        switch (event.key) {
          case "k":
            event.preventDefault();
            document.getElementById("searchInput").focus();
            break;
          case "e":
            event.preventDefault();
            showEditModal();
            break;
          case "s":
            event.preventDefault();
            exportToCSV();
            break;
          case "r":
            event.preventDefault();
            loadAllData();
            break;
          case "t":
            event.preventDefault();
            toggleTheme();
            break;
          case "v":
            event.preventDefault();
            showVentaModal();
            break;
        }
      }

      if (event.key === "Escape") closeAllModals();
    }

    function closeAllModals() {
      document.querySelectorAll(".modal").forEach(modal => { modal.style.display = "none"; });
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => { clearTimeout(timeout); func(...args); };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function normalizeText(text) {
      return (text ?? "")
        .toString()
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]+/g, " ")
        .trim()
        .replace(/\s+/g, " ");
    }

    function getSearchTokens(term) {
      return normalizeText(term).split(" ").filter(Boolean);
    }

    function rowHaystack(row) {
      return normalizeText(`${row.marca} ${row.modelo} ${row.tipo} ${row.proveedor} ${row.lista}`);
    }

    function formatCurrency(value) {
      if (value === null || value === undefined || isNaN(value)) return "0";
      return Math.round(parseFloat(value)).toString();
    }

    function generateRowId(row) {
      return `${row.lista}|${row.marca}|${row.modelo}|${row.tipo}|${row.proveedor}|${row.precio_compra}`;
    }

    function showStatus(message, type) {
      const statusEl = document.getElementById("statusMessage");
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
      statusEl.style.display = "block";
      setTimeout(() => { statusEl.style.display = "none"; }, type === "error" ? 4000 : 2500);
    }

    function copyPriceToClipboard(row) {
      const message = generateWhatsappMessage(row);

      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(message)
          .then(() => { showStatus("‚úÖ Mensaje copiado al portapapeles", "success"); highlightCopiedPrice(row); })
          .catch(() => fallbackCopyToClipboard(message, row));
      } else {
        fallbackCopyToClipboard(message, row);
      }
    }

    function fallbackCopyToClipboard(text, row) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.position = "fixed";
      textArea.style.left = "-999999px";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();

      try {
        document.execCommand("copy");
        showStatus("‚úÖ Mensaje copiado al portapapeles", "success");
        highlightCopiedPrice(row);
      } catch {
        showStatus("‚ùå Error al copiar mensaje", "error");
      }

      document.body.removeChild(textArea);
    }

    function highlightCopiedPrice(row) {
      const priceElements = document.querySelectorAll(".price-venta");
      priceElements.forEach(element => {
        if (element.textContent.includes(`Bs. ${formatCurrency(row.precio_venta)}`)) {
          const originalBg = element.style.backgroundColor;
          const originalColor = element.style.color;
          element.style.backgroundColor = "var(--accent)";
          element.style.color = "white";
          setTimeout(() => {
            element.style.backgroundColor = originalBg;
            element.style.color = originalColor;
          }, 800);
        }
      });
    }

    function handleSearch(e) {
      searchTerm = e.target.value;
      applyFilters();
    }

    function applyFilters() {
      let filtered = [...allData];

      if (searchTerm) {
        const tokens = getSearchTokens(searchTerm);
        filtered = filtered.filter(row => {
          const hay = rowHaystack(row);
          return tokens.every(t => hay.includes(t));
        });
      }

      const effectiveSortColumn = (!providersAccess && sortColumn === "precio_compra")
        ? "precio_venta"
        : sortColumn;

      if (effectiveSortColumn) sortData(filtered, effectiveSortColumn, sortDirection);

      filteredData = filtered;
      renderTable();
      updateResultsCount();
    }

    function sortTable(column) {
      if (sortColumn === column) sortDirection = sortDirection === "asc" ? "desc" : "asc";
      else { sortColumn = column; sortDirection = "asc"; }

      document.querySelectorAll("th").forEach(th => th.classList.remove("sort-asc", "sort-desc"));
      const currentTh = document.querySelector(`th[data-column="${column}"]`);
      if (currentTh) currentTh.classList.add(`sort-${sortDirection}`);

      applyFilters();
    }

    function sortData(data, column, direction) {
      data.sort((a, b) => {
        let valueA = a[column];
        let valueB = b[column];

        if (valueA === null || valueA === undefined) valueA = "";
        if (valueB === null || valueB === undefined) valueB = "";

        if (column === "precio_compra" || column === "precio_venta") {
          valueA = valueA || 0;
          valueB = valueB || 0;
          return direction === "asc" ? valueA - valueB : valueB - valueA;
        }

        valueA = valueA.toString().toLowerCase();
        valueB = valueB.toString().toLowerCase();

        if (valueA < valueB) return direction === "asc" ? -1 : 1;
        if (valueA > valueB) return direction === "asc" ? 1 : -1;
        return 0;
      });
    }

    function updateResultsCount() {
      const countEl = document.getElementById("resultsCount");
      const total = allData.length;
      const shown = filteredData.length;

      if (shown > 0) {
        countEl.textContent = `${shown} resultado${shown !== 1 ? "s" : ""}`;
        countEl.style.display = "block";
      } else {
        countEl.style.display = "none";
      }
    }
  </script>
</body>
</html>
