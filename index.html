<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#121212" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="description" content="Dr. Xiaomi - Gesti√≥n de precios de pantallas" />
  <title>Dr. Xiaomi</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    :root{
      --bg-primary:#121212;
      --bg-secondary:#1a1a1a;
      --bg-tertiary:#2d2d2d;
      --text-primary:#ffffff;
      --text-secondary:#b0b0b0;
      --accent:#ff7b00;
      --accent-light:#ffa94d;
      --accent-dark:#e66a00;
      --border:#333333;
      --success:#4caf50;
      --error:#f44336;
      --warning:#ff9800;
      --info:#2196f3;
      --edit:#ffeb3b;
      --whatsapp:#25D366;
      --card-shadow:0 4px 12px rgba(0,0,0,.4);
      --transition:all .3s cubic-bezier(.4,0,.2,1);
    }

    .light-mode{
      --bg-primary:#f8f9fa;
      --bg-secondary:#ffffff;
      --bg-tertiary:#f0f0f0;
      --text-primary:#2d3748;
      --text-secondary:#718096;
      --border:#e2e8f0;
      --card-shadow:0 4px 12px rgba(0,0,0,.1);
    }

    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html{height:100%;scroll-behavior:smooth}

    body{
      font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
      background:radial-gradient(circle at top,#1f2933 0,#020617 45%,#000 100%);
      color:var(--text-primary);
      line-height:1.6;
      min-height:100vh;
      overflow-x:hidden;
      transition:var(--transition);
      display:flex;
      justify-content:center;
      padding:12px;
    }

    .app-container{
      max-width:430px;width:100%;margin:0 auto;height:100vh;
      display:flex;flex-direction:column;background:var(--bg-primary);
      position:relative;border-radius:24px;overflow:hidden;
      box-shadow:0 20px 40px rgba(0,0,0,.6),0 0 0 1px rgba(148,163,184,.2);
    }

    .app-header{
      background:rgba(15,23,42,.9);
      backdrop-filter:blur(16px);
      -webkit-backdrop-filter:blur(16px);
      padding:14px 16px 10px;
      border-bottom:1px solid rgba(148,163,184,.25);
      position:sticky;top:0;z-index:100;
    }

    .header-content{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
    .app-title{display:flex;align-items:center;gap:12px}

    h1{color:var(--accent);margin:0;font-size:1.4rem;font-weight:700}

    .app-icon{
      width:42px;height:42px;border-radius:10px;
      background:linear-gradient(135deg,var(--accent) 0%,var(--accent-light) 100%);
      display:flex;align-items:center;justify-content:center;
      font-size:1.3rem;color:#fff;
      box-shadow:0 4px 12px rgba(255,123,0,.3);
    }

    .subtitle{
      color:var(--text-secondary);font-size:.75rem;margin-top:2px;
      text-align:left;font-weight:500;opacity:.9;
    }
    .subtitle span{color:var(--accent-light)}

    .admin-access{display:flex;gap:8px;align-items:center}

    .admin-btn{
      background:var(--bg-tertiary);
      color:var(--text-secondary);
      border:1px solid var(--border);
      padding:8px 10px;font-size:12px;border-radius:8px;
      cursor:pointer;transition:var(--transition);
    }
    .admin-btn:hover{background-color:var(--border);color:var(--text-primary)}

    .receipt-btn{
      border:1px solid var(--accent);
      display:inline-flex;align-items:center;justify-content:center;
      text-decoration:none;
    }
    .receipt-btn i{color:var(--accent);font-size:15px}
    .receipt-btn:hover{background:rgba(255,123,0,.15)}
    .receipt-btn:hover i{color:var(--accent-light)}

    /* Interruptor modo t√©cnico */
    .admin-toggle{
      display:inline-flex;align-items:center;gap:6px;
      background:transparent;border:none;padding:4px 6px;border-radius:999px;
      cursor:pointer;transition:var(--transition);
    }
    .admin-toggle:hover{background:rgba(148,163,184,.1)}
    .toggle-label{
      font-size:11px;font-weight:600;letter-spacing:.02em;
      color:var(--text-secondary);text-transform:uppercase;
    }
    .toggle-pill{
      width:34px;height:18px;border-radius:999px;background:var(--bg-tertiary);
      border:1px solid #dc2626;position:relative;transition:var(--transition);
    }
    .toggle-circle{
      position:absolute;width:14px;height:14px;border-radius:999px;
      background:#dc2626;top:1px;left:2px;transition:var(--transition);
    }
    .admin-toggle.on .toggle-pill{background:rgba(34,197,94,.15);border-color:#22c55e}
    .admin-toggle.on .toggle-circle{transform:translateX(14px);background:#22c55e}
    .admin-toggle.on .toggle-label{color:#22c55e}

    .search-section{
      padding:12px 16px 10px;background:var(--bg-secondary);
      border-bottom:1px solid var(--border);
    }
    .search-controls{display:flex;flex-direction:column;gap:12px}
    .search-box{width:100%;position:relative}

    input[type="text"]{
      width:100%;
      padding:12px 44px 12px 16px; /* deja espacio para icono lupa */
      background-color:var(--bg-primary);
      border:1px solid var(--border);
      border-radius:10px;
      color:var(--text-primary);
      font-size:16px;
      transition:var(--transition);
      box-shadow:var(--card-shadow);
    }
    input[type="text"]:focus{
      outline:none;border-color:var(--accent);
      box-shadow:0 0 0 2px rgba(255,123,0,.1);
    }

    .search-icon{
      position:absolute;right:16px;top:50%;
      transform:translateY(-50%);color:var(--text-secondary);
    }

    .main-content{flex:1;padding:12px 12px 8px;overflow-y:auto}

    .table-container{
      overflow-x:auto;border-radius:16px;border:1px solid var(--border);
      position:relative;box-shadow:var(--card-shadow);
      background:var(--bg-secondary);-webkit-overflow-scrolling:touch;
      margin-bottom:60px;
    }

    table{width:100%;border-collapse:collapse}
    thead{position:sticky;top:0;z-index:10}

    th{
      background-color:var(--bg-tertiary);
      padding:10px 6px;text-align:left;font-weight:600;
      border-bottom:1px solid var(--border);
      cursor:pointer;user-select:none;position:relative;
      transition:var(--transition);font-size:12px;white-space:nowrap;
      color:var(--text-primary);
    }
    th:hover{background-color:var(--border)}
    th.sort-asc::after{content:" ‚ñ≤";font-size:10px;color:var(--accent)}
    th.sort-desc::after{content:" ‚ñº";font-size:10px;color:var(--accent)}

    td{
      padding:8px 6px;border-bottom:1px solid var(--border);
      background-color:var(--bg-secondary);
      transition:var(--transition);font-size:12px;
    }
    tbody tr:hover td{background-color:var(--bg-tertiary)}

    mark{background-color:var(--accent);color:#fff;padding:1px 3px;border-radius:4px}

    input.editable{
      width:100%;padding:6px;background-color:transparent;border:1px solid transparent;
      color:var(--text-primary);border-radius:6px;transition:var(--transition);font-size:11px;
    }
    input.editable:focus{
      outline:none;border-color:var(--accent);background-color:var(--bg-primary);
      box-shadow:0 0 0 1px rgba(255,123,0,.2);
    }
    input.editable-compra{border:1px solid var(--edit);background-color:rgba(255,235,59,.05)}

    .price-compra{color:var(--accent);font-weight:600}
    .price-venta{
      color:var(--success);font-weight:600;cursor:pointer;
      padding:4px 8px;border-radius:999px;transition:all .3s ease;
    }
    .price-venta:hover{background-color:var(--accent);color:#fff}

    .tipo-oled{color:var(--accent);font-weight:600}
    .tipo-lcd{color:var(--text-secondary);font-weight:600}

    .status{
      position:fixed;bottom:80px;left:50%;transform:translateX(-50%);
      max-width:360px;width:calc(100% - 48px);
      z-index:999;padding:8px 14px;border-radius:999px;
      text-align:center;font-weight:500;font-size:.75rem;
      background:rgba(15,23,42,.96);
      border:1px solid rgba(148,163,184,.5);
      box-shadow:0 10px 30px rgba(0,0,0,.6);
      display:none;
    }
    .status.success{color:#bbf7d0}
    .status.error{color:#fecaca}
    .status.info{color:#bfdbfe}
    .status.warning{color:#fed7aa}

    .empty{text-align:center;padding:40px 15px;color:var(--text-secondary);font-size:.9rem}
    .empty .icon{font-size:2rem;margin-bottom:12px;opacity:.5}

    .results-count{text-align:left;color:var(--text-secondary);margin-bottom:6px;font-size:.75rem;padding:4px 2px;display:none}

    .price-container{display:flex;align-items:center;gap:6px;justify-content:flex-start}
    .share-icon{
      color:var(--accent);font-size:14px;cursor:pointer;
      padding:4px;border-radius:999px;transition:var(--transition);opacity:.7;
    }
    .share-icon:hover{opacity:1;background-color:rgba(255,123,0,.1)}

    /* Ocultar columnas proveedor/compra cuando no hay acceso */
    .hide-columns .col-proveedor,
    .hide-columns .col-compra{display:none}

    .edit-notice{
      text-align:center;padding:8px 10px;background:var(--bg-tertiary);
      border:1px solid var(--edit);border-radius:10px;margin-bottom:10px;
      color:var(--edit);font-size:11px;box-shadow:var(--card-shadow);
    }

    .bottom-nav{
      position:sticky;bottom:0;left:0;right:0;
      background:rgba(15,23,42,.98);
      backdrop-filter:blur(14px);
      -webkit-backdrop-filter:blur(14px);
      border-top:1px solid rgba(148,163,184,.3);
      display:flex;padding:6px 14px;z-index:100;
    }
    .nav-item{
      flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
      padding:4px;color:var(--text-secondary);
      transition:transform .15s ease,background .15s ease,color .15s ease;
      border-radius:12px;cursor:pointer;position:relative;text-decoration:none;
    }
    .nav-item.active::before{
      content:"";position:absolute;top:0;height:3px;width:60%;
      border-radius:999px;background:var(--accent);
    }
    .nav-item.active{color:var(--accent);transform:translateY(-1px);background:rgba(15,23,42,.6)}
    .nav-item:hover{background:rgba(15,23,42,.6);color:var(--text-primary)}
    .nav-icon{font-size:1rem;margin-bottom:2px}
    .nav-label{font-size:.65rem;font-weight:500}

    .modal{
      display:none;position:fixed;top:0;left:0;width:100%;height:100%;
      background-color:rgba(0,0,0,.8);z-index:1000;
      align-items:center;justify-content:center;
      backdrop-filter:blur(5px);padding:16px;animation:fadeIn .3s ease;
    }
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}

    .modal-content{
      background-color:var(--bg-secondary);padding:20px;border-radius:16px;width:100%;max-width:400px;
      border:1px solid var(--border);box-shadow:0 10px 25px rgba(0,0,0,.3);
      animation:slideUp .3s ease;max-height:90vh;overflow-y:auto;
    }
    @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}

    .modal h2{margin-bottom:16px;color:var(--accent);text-align:center;font-size:1.1rem;font-weight:600}
    .modal-input{
      width:100%;padding:12px;margin-bottom:14px;background-color:var(--bg-primary);
      border:1px solid var(--border);border-radius:10px;color:var(--text-primary);
      font-size:15px;transition:var(--transition);
    }
    .modal-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(255,123,0,.1)}
    .modal-buttons{display:flex;gap:10px;justify-content:flex-end}
    .modal-btn{
      padding:10px 18px;border:none;border-radius:999px;cursor:pointer;font-weight:600;
      transition:var(--transition);font-size:13px;
    }
    .modal-btn.primary{background:var(--accent);color:#fff}
    .modal-btn.primary:hover{background:var(--accent-dark)}
    .modal-btn.secondary{background-color:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border)}
    .modal-btn.secondary:hover{background-color:var(--border)}
    .modal-text{margin-bottom:12px;color:var(--text-secondary);text-align:center;font-size:13px}

    @media (max-width:480px){
      .app-container{border-radius:0;max-width:100%;box-shadow:none}
    }
    @media (min-width:768px){
      .app-container{max-width:430px}
    }
    @media (hover:none) and (pointer:coarse){
      .admin-btn,.nav-item{min-height:40px;min-width:40px}
      input{font-size:16px}
      .table-container{-webkit-overflow-scrolling:touch}
    }
  </style>
</head>

<body>
  <div class="app-container">
    <header class="app-header">
      <div class="header-content">
        <div class="app-title">
          <div class="app-icon"><i class="fas fa-mobile-alt"></i></div>
          <h1>DR. XIAOMI</h1>
        </div>

        <div class="admin-access">
          <button class="admin-toggle" id="providersBtn" title="Modo t√©cnico (ver datos bloqueados)">
            <span class="toggle-label">T√©cnico</span>
            <span class="toggle-pill"><span class="toggle-circle"></span></span>
          </button>

          <a href="http://xiaomi.scz.red/1/" class="admin-btn receipt-btn" id="receiptBtn" title="Recibo">
            <i class="fas fa-receipt"></i>
          </a>

          <button class="theme-toggle admin-btn" id="themeToggle" title="Cambiar tema">
            <i class="fas fa-sun"></i>
          </button>
        </div>
      </div>

      <div class="subtitle">
        Sistema de gesti√≥n de precios ¬∑ <span id="lastUpdate">‚Äî</span>
      </div>
    </header>

    <section class="search-section">
      <div id="editNotice" class="edit-notice" style="display:none;">
        <i class="fas fa-edit"></i>
        <strong>Modo Edici√≥n Activado</strong> - Puedes editar precios directamente en la tabla
      </div>

      <div class="search-controls">
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Buscar marca, modelo, tipo o proveedor..." />
          <div class="search-icon"><i class="fas fa-search"></i></div>
        </div>
      </div>
    </section>

    <main class="main-content">
      <div id="statusMessage" class="status"></div>
      <div id="resultsCount" class="results-count"></div>

      <div class="table-container">
        <table id="resultsTable">
          <thead>
            <tr>
              <th data-column="marca" class="col-marca">Marca</th>
              <th data-column="modelo" class="col-modelo">Modelo</th>
              <th data-column="tipo" class="col-tipo">Tipo</th>
              <th data-column="proveedor" class="col-proveedor">Prov.</th>
              <th data-column="precio_compra" class="col-compra">Compra</th>
              <th data-column="precio_venta" class="col-venta">Venta</th>
            </tr>
          </thead>
          <tbody id="resultsBody"></tbody>
        </table>
      </div>
    </main>

    <nav class="bottom-nav">
      <div class="nav-item active" data-tab="main">
        <div class="nav-icon"><i class="fas fa-home"></i></div>
        <div class="nav-label">Inicio</div>
      </div>

      <div class="nav-item" data-tab="favorites">
        <div class="nav-icon"><i class="fas fa-star"></i></div>
        <div class="nav-label">TIKTOK</div>
      </div>

      <a href="http://xiaomi.scz.red/1/" class="nav-item" data-tab="compare">
        <div class="nav-icon"><i class="fas fa-balance-scale"></i></div>
        <div class="nav-label">Recibo</div>
      </a>
    </nav>
  </div>

  <!-- Modales -->
  <div class="modal" id="adminModal">
    <div class="modal-content">
      <h2><i class="fas fa-lock"></i> Acceso Administrativo</h2>
      <input type="password" id="adminPassword" class="modal-input" placeholder="Ingrese la clave de acceso" autocomplete="off" />
      <div class="modal-buttons">
        <button class="modal-btn secondary" id="cancelAdminBtn">Cancelar</button>
        <button class="modal-btn primary" id="confirmAdminBtn">Acceder</button>
      </div>
    </div>
  </div>

  <div class="modal" id="editModal">
    <div class="modal-content">
      <h2><i class="fas fa-edit"></i> Modo Edici√≥n</h2>
      <p class="modal-text">Ingrese la clave para editar precios de compra y toda la lista</p>
      <input type="password" id="editPassword" class="modal-input" placeholder="Clave de edici√≥n" autocomplete="off" />
      <div class="modal-buttons">
        <button class="modal-btn secondary" id="cancelEditBtn">Cancelar</button>
        <button class="modal-btn primary" id="confirmEditBtn">Activar Edici√≥n</button>
      </div>
    </div>
  </div>

  <div class="modal" id="providersModal">
    <div class="modal-content">
      <h2><i class="fas fa-eye"></i> Ver Importadoras</h2>
      <p class="modal-text">Ingrese la clave para ver las importadoras y precios de compra</p>
      <input type="password" id="providersPassword" class="modal-input" placeholder="Clave para ver importadoras" autocomplete="off" />
      <div class="modal-buttons">
        <button class="modal-btn secondary" id="cancelProvidersBtn">Cancelar</button>
        <button class="modal-btn primary" id="confirmProvidersBtn">Ver Importadoras</button>
      </div>
    </div>
  </div>

  <div class="modal" id="ventaModal">
    <div class="modal-content">
      <h2><i class="fas fa-edit"></i> Editar Precio de Venta</h2>
      <p class="modal-text">Ingrese la clave para editar el precio de venta</p>
      <input type="password" id="ventaPassword" class="modal-input" placeholder="Clave para editar venta" autocomplete="off" />
      <div class="modal-buttons">
        <button class="modal-btn secondary" id="cancelVentaBtn">Cancelar</button>
        <button class="modal-btn primary" id="confirmVentaBtn">Editar Precio</button>
      </div>
    </div>
  </div>

  <div class="modal" id="whatsappModal">
    <div class="modal-content">
      <h2><i class="fab fa-whatsapp"></i> Compartir por WhatsApp</h2>
      <div id="whatsappMessage" style="margin-bottom:12px;color:var(--text-primary);text-align:center;font-size:14px;padding:12px;background:var(--bg-primary);border-radius:10px;border:1px solid var(--border);"></div>
      <p class="modal-text">El mensaje se abrir√° en WhatsApp. ¬øDesea continuar?</p>
      <div class="modal-buttons">
        <button class="modal-btn secondary" id="cancelWhatsappBtn">Cancelar</button>
        <button class="modal-btn primary" id="confirmWhatsappBtn" style="background-color:var(--whatsapp);">
          <i class="fab fa-whatsapp"></i> Abrir WhatsApp
        </button>
      </div>
    </div>
  </div>

  <div class="modal" id="compareModal">
    <div class="modal-content">
      <h2><i class="fas fa-balance-scale"></i> Comparar Productos</h2>
      <div id="compareResults" style="max-height:400px;overflow-y:auto;"></div>
      <div class="modal-buttons">
        <button class="modal-btn secondary" id="closeCompareBtn">Cerrar</button>
        <button class="modal-btn primary" id="clearCompareBtn">
          <i class="fas fa-trash"></i> Limpiar
        </button>
      </div>
    </div>
  </div>

  <script>
    const CONFIG = [
      { nombre: "J&A", archivo: "https://xiaomi.scz.red/precio/data/ja2.csv" },
      { nombre: "CentralCell", archivo: "https://xiaomi.scz.red/precio/data/centralcel.csv" },
      { nombre: "Osmobil", archivo: "https://xiaomi.scz.red/precio/data/osmobil.csv" },
      { nombre: "CFH LP", archivo: "https://xiaomi.scz.red/precio/data/CFH.csv" },
      { nombre: "BITE", archivo: "https://xiaomi.scz.red/precio/data/boe.csv" }
    ];

    const ADMIN_PASSWORD = "123456";
    const EDIT_PASSWORD = "123456";
    const VENTA_PASSWORD = "123456";
    const PROVIDERS_PASSWORD = "123456";

    let allData = [];
    let filteredData = [];

    // ‚úÖ por defecto: mejor precio primero (compra si hay acceso, si no -> venta)
    let sortColumn = "precio_compra";
    let sortDirection = "asc";

    let searchTerm = "";
    let showProviders = false;      // solo afecta UI del toggle (no recorta lista)
    let editMode = false;
    let ventaEditMode = false;
    let providersAccess = false;

    let currentWhatsappRow = null;
    let comparingItems = new Set();
    let currentTab = "main";
    let isLightMode = false;

    document.addEventListener("DOMContentLoaded", function () {
      initializeApp();
    });

    function initializeApp() {
      loadAllData();
      setupEventListeners();
      updateProvidersUI();
      updateTableColumns();
      checkOnlineStatus();
      updateLastUpdateLabel();
      registerServiceWorker();

      const savedTheme = localStorage.getItem("themePreference");
      if (savedTheme === "light") toggleTheme();
    }

    function updateLastUpdateLabel() {
      const el = document.getElementById("lastUpdate");
      if (!el) return;
      const hoy = new Date();
      el.textContent = hoy.toLocaleDateString("es-BO", { day: "2-digit", month: "2-digit", year: "2-digit" });
    }

    function registerServiceWorker() {
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("./sw.js").catch(err => console.log("Service Worker error:", err));
      }
    }

    function setupEventListeners() {
      const searchInput = document.getElementById("searchInput");
      searchInput.addEventListener("input", debounce(handleSearch, 250));

      const providersBtn = document.getElementById("providersBtn");
      if (providersBtn) providersBtn.addEventListener("click", handleProvidersButtonClick);

      document.getElementById("themeToggle").addEventListener("click", toggleTheme);

      setupModalEvents();

      document.querySelectorAll(".nav-item").forEach(item => item.addEventListener("click", handleNavigation));

      document.addEventListener("keydown", handleKeyboardShortcuts);
      window.addEventListener("online", handleOnlineStatus);
      window.addEventListener("offline", handleOnlineStatus);

      document.querySelectorAll('th[data-column]').forEach(th => {
        th.addEventListener("click", () => sortTable(th.getAttribute("data-column")));
      });
    }

    function setupModalEvents() {
      document.getElementById("cancelAdminBtn").addEventListener("click", hideAdminModal);
      document.getElementById("confirmAdminBtn").addEventListener("click", handleAdminAccess);

      document.getElementById("cancelEditBtn").addEventListener("click", hideEditModal);
      document.getElementById("confirmEditBtn").addEventListener("click", handleEditAccess);

      document.getElementById("cancelProvidersBtn").addEventListener("click", hideProvidersModal);
      document.getElementById("confirmProvidersBtn").addEventListener("click", handleProvidersAccess);

      document.getElementById("cancelVentaBtn").addEventListener("click", hideVentaModal);
      document.getElementById("confirmVentaBtn").addEventListener("click", handleVentaAccess);

      document.getElementById("cancelWhatsappBtn").addEventListener("click", hideWhatsappModal);
      document.getElementById("confirmWhatsappBtn").addEventListener("click", handleWhatsappShare);

      document.getElementById("closeCompareBtn").addEventListener("click", hideCompareModal);
      document.getElementById("clearCompareBtn").addEventListener("click", clearCompare);

      document.getElementById("adminPassword").addEventListener("keypress", e => { if (e.key === "Enter") handleAdminAccess(); });
      document.getElementById("editPassword").addEventListener("keypress", e => { if (e.key === "Enter") handleEditAccess(); });
      document.getElementById("ventaPassword").addEventListener("keypress", e => { if (e.key === "Enter") handleVentaAccess(); });
      document.getElementById("providersPassword").addEventListener("keypress", e => { if (e.key === "Enter") handleProvidersAccess(); });
    }

    function toggleTheme() {
      isLightMode = !isLightMode;
      const toggleIcon = document.querySelector("#themeToggle i");
      if (isLightMode) {
        document.body.classList.add("light-mode");
        if (toggleIcon) toggleIcon.className = "fas fa-moon";
        localStorage.setItem("themePreference", "light");
      } else {
        document.body.classList.remove("light-mode");
        if (toggleIcon) toggleIcon.className = "fas fa-sun";
        localStorage.setItem("themePreference", "dark");
      }
    }

    async function loadAllData() {
      showStatus("üîÑ Cargando datos desde archivos CSV...", "info");
      try {
        allData = [];
        let loadedCount = 0;
        let totalRecords = 0;

        for (const provider of CONFIG) {
          try {
            const data = await loadCSVData(provider.archivo, provider.nombre);
            allData = [...allData, ...data];
            loadedCount++;
            totalRecords += data.length;
          } catch (error) {
            console.error(`Error cargando datos de ${provider.nombre}:`, error);
          }
        }

        const storedData = localStorage.getItem("customPriceData");
        if (storedData) {
          try {
            const customData = JSON.parse(storedData);
            allData = [...allData, ...customData];
          } catch (e) {
            console.error("Error cargando datos personalizados:", e);
          }
        }

        loadEditsFromStorage();
        verifyDataIntegrity();
        applyFilters();

        showStatus(`‚úÖ ${totalRecords} precios cargados de ${loadedCount} proveedores`, "success");
      } catch (error) {
        console.error("Error cargando datos:", error);
        showStatus("‚ùå Error cargando datos. Verifique la conexi√≥n.", "error");
      }
    }

    async function loadCSVData(filePath, providerName) {
      try {
        const response = await fetch(filePath);
        if (!response.ok) throw new Error(`Error ${response.status}`);
        const csvText = await response.text();
        const data = parseCSVCorregido(csvText, providerName);
        localStorage.setItem(`backup_${providerName}`, JSON.stringify(data));
        return data;
      } catch (error) {
        console.error(`Error cargando ${filePath}:`, error);
        const backupData = localStorage.getItem(`backup_${providerName}`);
        if (backupData) return JSON.parse(backupData);
        return [];
      }
    }

    function parseCSVCorregido(csvText, providerName) {
      const lines = csvText.split("\n").filter(line => line.trim() !== "");
      const data = [];
      if (lines.length === 0) return [];

      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue;

        const columns = parseCSVLine(line);

        if (columns.length >= 6) {
          const marca = columns[0] || "Desconocido";
          const modelo = columns[1] || "Desconocido";
          const tipo = (columns[2] || "LCD").toUpperCase();
          const proveedor = columns[3] || providerName;
          const precio_compra = parsePrice(columns[4]);
          const precio_venta = parsePrice(columns[5]);

          const row = {
            lista: providerName,
            marca: marca.trim(),
            modelo: modelo.trim(),
            tipo: tipo.trim(),
            proveedor: proveedor.trim(),
            precio_compra,
            precio_venta
          };

          if (row.marca !== "Desconocido" && row.modelo !== "Desconocido") data.push(row);
        } else if (columns.length === 5) {
          const marca = columns[0] || "Desconocido";
          const modelo = columns[1] || "Desconocido";
          const tipo = (columns[2] || "LCD").toUpperCase();
          const precio_compra = parsePrice(columns[3]);
          const precio_venta = parsePrice(columns[4]);

          const row = {
            lista: providerName,
            marca: marca.trim(),
            modelo: modelo.trim(),
            tipo: tipo.trim(),
            proveedor: providerName,
            precio_compra,
            precio_venta
          };
          data.push(row);
        }
      }
      return data;
    }

    function parseCSVLine(line) {
      const result = [];
      let current = "";
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') inQuotes = !inQuotes;
        else if (char === "," && !inQuotes) { result.push(current.trim()); current = ""; }
        else current += char;
      }
      result.push(current.trim());
      return result.map(field => field.replace(/^"|"$/g, ""));
    }

    function parsePrice(priceStr) {
      if (!priceStr || priceStr.trim() === "") return 0;

      let str = priceStr.toString().trim();
      str = str.replace(/[^\d.,-]/g, "");

      const isNegative = str.startsWith("-");
      if (isNegative) str = str.substring(1);

      const lastComma = str.lastIndexOf(",");
      const lastDot = str.lastIndexOf(".");

      let cleaned;
      if (lastComma > lastDot) cleaned = str.replace(/\./g, "").replace(",", ".");
      else cleaned = str.replace(/,/g, "");

      const num = parseFloat(cleaned);
      if (isNaN(num)) return 0;
      const rounded = Math.round(num);
      return isNegative ? -rounded : rounded;
    }

    // ===== PROVEEDORES (interruptor modo t√©cnico) =====
    function handleProvidersButtonClick() {
      if (!providersAccess) {
        showProvidersModal();
        return;
      }
      // Ahora SOLO cambia el estado visual (y columnas), no recorta data.
      showProviders = !showProviders;
      updateProvidersUI();
      applyFilters();
    }

    function updateProvidersUI() {
      const btn = document.getElementById("providersBtn");
      if (!btn) return;

      if (!providersAccess) {
        btn.classList.remove("on");
        btn.title = "Modo t√©cnico bloqueado (requiere clave)";
      } else {
        btn.classList.toggle("on", showProviders);
        btn.title = showProviders
          ? "Modo t√©cnico activo: mostrando importadoras y precios de compra"
          : "Modo t√©cnico desactivado";
      }
    }

    function updateTableColumns() {
      const tableContainer = document.querySelector(".table-container");
      if (!tableContainer) return;
      if (!providersAccess) tableContainer.classList.add("hide-columns");
      else tableContainer.classList.remove("hide-columns");
    }

    function toggleFavorite(row) {
      const favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
      const itemId = generateRowId(row);

      if (favorites.includes(itemId)) {
        favorites.splice(favorites.indexOf(itemId), 1);
        showStatus("‚ù§Ô∏è Eliminado de favoritos", "info");
      } else {
        favorites.push(itemId);
        showStatus("‚≠ê Agregado a favoritos", "success");
      }
      localStorage.setItem("favorites", JSON.stringify(favorites));
    }

    function toggleCompare(row) {
      const itemId = generateRowId(row);
      if (comparingItems.has(itemId)) {
        comparingItems.delete(itemId);
        showStatus("üìä Eliminado de comparaci√≥n", "info");
      } else {
        if (comparingItems.size >= 4) {
          showStatus("‚ùå M√°ximo 4 productos para comparar", "error");
          return;
        }
        comparingItems.add(itemId);
        showStatus("üìä Agregado a comparaci√≥n", "success");
      }
    }

    function showCompareModal() {
      const compareResults = document.getElementById("compareResults");
      compareResults.innerHTML = "";

      if (comparingItems.size === 0) {
        compareResults.innerHTML = '<p style="text-align:center;color:var(--text-secondary);">No hay productos para comparar</p>';
      } else {
        const itemsToCompare = allData.filter(row => comparingItems.has(generateRowId(row)));
        let compareHTML = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">';

        itemsToCompare.forEach(item => {
          compareHTML += `
            <div style="background:var(--bg-primary);padding:12px;border-radius:10px;border:1px solid var(--border);">
              <h4 style="color:var(--accent);margin-bottom:6px;font-size:0.9rem;">
                ${item.marca} ${item.modelo}
              </h4>
              <p style="font-size:0.8rem;"><strong>Tipo:</strong> ${item.tipo}</p>
              <p style="font-size:0.8rem;"><strong>Proveedor:</strong> ${item.proveedor}</p>
              <p style="font-size:0.8rem;"><strong>Compra:</strong> Bs. ${formatCurrency(item.precio_compra)}</p>
              <p style="font-size:0.8rem;"><strong>Venta:</strong> Bs. ${formatCurrency(item.precio_venta)}</p>
            </div>
          `;
        });

        compareHTML += "</div>";
        compareResults.innerHTML = compareHTML;
      }

      document.getElementById("compareModal").style.display = "flex";
    }

    function clearCompare() {
      comparingItems.clear();
      hideCompareModal();
      showStatus("üóëÔ∏è Comparaci√≥n limpiada", "success");
    }

    function exportToCSV() {
      const headers = ["Marca", "Modelo", "Tipo", "Proveedor", "Precio Compra", "Precio Venta"];
      const csvContent = [
        headers.join(","),
        ...filteredData.map(row =>
          [
            `"${row.marca}"`,
            `"${row.modelo}"`,
            `"${row.tipo}"`,
            `"${row.proveedor}"`,
            row.precio_compra,
            row.precio_venta
          ].join(",")
        )
      ].join("\n");

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `precios_pantallas_${new Date().toISOString().split("T")[0]}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showStatus("üì§ Datos exportados correctamente", "success");
    }

    function checkOnlineStatus() {
      if (!navigator.onLine) showStatus("‚ö†Ô∏è Est√°s trabajando en modo offline", "warning");
    }
    function handleOnlineStatus() {
      if (navigator.onLine) showStatus("‚úÖ Conexi√≥n restaurada", "success");
      else showStatus("‚ö†Ô∏è Modo offline activado", "warning");
    }

    function handleNavigation(event) {
      const tab = event.currentTarget.getAttribute("data-tab");
      document.querySelectorAll(".nav-item").forEach(item => item.classList.remove("active"));
      event.currentTarget.classList.add("active");
      currentTab = tab;

      switch (tab) {
        case "favorites":
          showFavorites();
          break;
        case "compare":
          showCompareModal();
          break;
        default:
          applyFilters();
          break;
      }
    }

    function showFavorites() {
      const favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
      filteredData = allData.filter(row => favorites.includes(generateRowId(row)));
      // ordena igual por mejor precio
      const effectiveSortColumn = (!providersAccess && sortColumn === "precio_compra") ? "precio_venta" : sortColumn;
      sortData(filteredData, effectiveSortColumn, sortDirection);
      renderTable();
      updateResultsCount();
    }

    function handleKeyboardShortcuts(event) {
      if (event.ctrlKey || event.metaKey) {
        switch (event.key) {
          case "k":
            event.preventDefault();
            document.getElementById("searchInput").focus();
            break;
          case "e":
            event.preventDefault();
            showEditModal();
            break;
          case "s":
            event.preventDefault();
            exportToCSV();
            break;
          case "r":
            event.preventDefault();
            loadAllData();
            break;
          case "t":
            event.preventDefault();
            toggleTheme();
            break;
          case "v":
            event.preventDefault();
            showVentaModal();
            break;
        }
      }

      if (event.key === "Escape") closeAllModals();
    }

    function closeAllModals() {
      document.querySelectorAll(".modal").forEach(modal => { modal.style.display = "none"; });
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => { clearTimeout(timeout); func(...args); };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // ‚úÖ normalizaci√≥n que conserva palabras (para buscar "tecno spark")
    function normalizeText(text) {
      return (text ?? "")
        .toString()
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]+/g, " ")
        .trim()
        .replace(/\s+/g, " ");
    }

    function getSearchTokens(term) {
      return normalizeText(term).split(" ").filter(Boolean);
    }

    function rowHaystack(row) {
      return normalizeText(`${row.marca} ${row.modelo} ${row.tipo} ${row.proveedor} ${row.lista}`);
    }

    function formatCurrency(value) {
      if (value === null || value === undefined || isNaN(value)) return "0";
      return Math.round(parseFloat(value)).toString();
    }

    function generateRowId(row) {
      return `${row.lista}|${row.marca}|${row.modelo}|${row.tipo}|${row.proveedor}|${row.precio_compra}`;
    }

    function showStatus(message, type) {
      const statusEl = document.getElementById("statusMessage");
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
      statusEl.style.display = "block";
      setTimeout(() => { statusEl.style.display = "none"; }, type === "error" ? 4000 : 2500);
    }

    function copyPriceToClipboard(row) {
      const message = generateWhatsappMessage(row);

      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(message)
          .then(() => { showStatus("‚úÖ Mensaje copiado al portapapeles", "success"); highlightCopiedPrice(row); })
          .catch(() => fallbackCopyToClipboard(message, row));
      } else {
        fallbackCopyToClipboard(message, row);
      }
    }

    function fallbackCopyToClipboard(text, row) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.position = "fixed";
      textArea.style.left = "-999999px";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();

      try {
        document.execCommand("copy");
        showStatus("‚úÖ Mensaje copiado al portapapeles", "success");
        highlightCopiedPrice(row);
      } catch {
        showStatus("‚ùå Error al copiar mensaje", "error");
      }

      document.body.removeChild(textArea);
    }

    function highlightCopiedPrice(row) {
      const priceElements = document.querySelectorAll(".price-venta");
      priceElements.forEach(element => {
        if (element.textContent.includes(`Bs. ${formatCurrency(row.precio_venta)}`)) {
          const originalBg = element.style.backgroundColor;
          const originalColor = element.style.color;
          element.style.backgroundColor = "var(--accent)";
          element.style.color = "white";
          setTimeout(() => {
            element.style.backgroundColor = originalBg;
            element.style.color = originalColor;
          }, 800);
        }
      });
    }

    function handleSearch(e) {
      searchTerm = e.target.value;
      applyFilters();
    }

    // ‚úÖ ahora SIEMPRE muestra todo, pero ordenado desde mejor precio
    function applyFilters() {
      let filtered = [...allData];

      if (searchTerm) {
        const tokens = getSearchTokens(searchTerm);
        filtered = filtered.filter(row => {
          const hay = rowHaystack(row);
          return tokens.every(t => hay.includes(t));
        });
      }

      // si no hay acceso a compra, ordenamos por venta para que tenga sentido
      const effectiveSortColumn = (!providersAccess && sortColumn === "precio_compra")
        ? "precio_venta"
        : sortColumn;

      if (effectiveSortColumn) sortData(filtered, effectiveSortColumn, sortDirection);

      filteredData = filtered;
      renderTable();
      updateResultsCount();
    }

    function sortTable(column) {
      if (sortColumn === column) sortDirection = sortDirection === "asc" ? "desc" : "asc";
      else { sortColumn = column; sortDirection = "asc"; }

      document.querySelectorAll("th").forEach(th => th.classList.remove("sort-asc", "sort-desc"));
      const currentTh = document.querySelector(`th[data-column="${column}"]`);
      if (currentTh) currentTh.classList.add(`sort-${sortDirection}`);

      applyFilters();
    }

    function sortData(data, column, direction) {
      data.sort((a, b) => {
        let valueA = a[column];
        let valueB = b[column];

        if (valueA === null || valueA === undefined) valueA = "";
        if (valueB === null || valueB === undefined) valueB = "";

        if (column === "precio_compra" || column === "precio_venta") {
          valueA = valueA || 0;
          valueB = valueB || 0;
          return direction === "asc" ? valueA - valueB : valueB - valueA;
        }

        valueA = valueA.toString().toLowerCase();
        valueB = valueB.toString().toLowerCase();

        if (valueA < valueB) return direction === "asc" ? -1 : 1;
        if (valueA > valueB) return direction === "asc" ? 1 : -1;
        return 0;
      });
    }

    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    function highlightMatches(text) {
      if (!searchTerm || !text) return text || "";
      const tokens = getSearchTokens(searchTerm);
      if (!tokens.length) return text.toString();

      const pattern = tokens.map(t => escapeRegExp(t)).join("|");
      const regex = new RegExp(`(${pattern})`, "gi");
      return text.toString().replace(regex, match => `<mark>${match}</mark>`);
    }

    function renderTable() {
      const tbody = document.getElementById("resultsBody");
      tbody.innerHTML = "";

      if (!filteredData || filteredData.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 6;
        td.className = "empty";
        td.innerHTML = `<div class="icon">üîç</div>${searchTerm ? "No se encontraron resultados" : "No hay datos para mostrar"}`;
        tr.appendChild(td);
        tbody.appendChild(tr);
        updateResultsCount();
        return;
      }

      filteredData.forEach(row => {
        const tr = document.createElement("tr");

        const tdMarca = document.createElement("td");
        tdMarca.className = "col-marca";
        tdMarca.innerHTML = highlightMatches(row.marca);
        tr.appendChild(tdMarca);

        const tdModelo = document.createElement("td");
        tdModelo.className = "col-modelo";
        tdModelo.innerHTML = highlightMatches(row.modelo);
        tr.appendChild(tdModelo);

        const tdTipo = document.createElement("td");
        tdTipo.className = `col-tipo ${row.tipo === "OLED" ? "tipo-oled" : "tipo-lcd"}`;
        tdTipo.innerHTML = highlightMatches(row.tipo);
        tr.appendChild(tdTipo);

        const tdProveedor = document.createElement("td");
        tdProveedor.className = "col-proveedor";
        tdProveedor.innerHTML = providersAccess ? highlightMatches(row.proveedor) : "";
        tr.appendChild(tdProveedor);

        const tdCompra = document.createElement("td");
        tdCompra.className = "col-compra";
        if (providersAccess) {
          if (editMode) {
            const input = document.createElement("input");
            input.type = "text";
            input.className = "editable editable-compra";
            input.dataset.id = generateRowId(row);
            input.dataset.field = "precio_compra";
            input.value = formatCurrency(row.precio_compra);
            input.placeholder = "0";
            input.addEventListener("change", handleEdit);
            tdCompra.appendChild(input);
          } else {
            const spanCompra = document.createElement("span");
            spanCompra.className = "price-compra";
            spanCompra.textContent = `Bs. ${formatCurrency(row.precio_compra)}`;
            tdCompra.appendChild(spanCompra);
          }
        }
        tr.appendChild(tdCompra);

        const tdVenta = document.createElement("td");
        tdVenta.className = "col-venta";

        if (ventaEditMode) {
          const inputVenta = document.createElement("input");
          inputVenta.type = "text";
          inputVenta.className = "editable";
          inputVenta.dataset.id = generateRowId(row);
          inputVenta.dataset.field = "precio_venta";
          inputVenta.value = formatCurrency(row.precio_venta);
          inputVenta.placeholder = "0";
          inputVenta.addEventListener("change", handleEdit);
          tdVenta.appendChild(inputVenta);
        } else {
          const priceContainer = document.createElement("div");
          priceContainer.className = "price-container";

          const priceSpan = document.createElement("span");
          priceSpan.className = "price-venta";
          priceSpan.textContent = `Bs. ${formatCurrency(row.precio_venta)}`;
          priceSpan.title = "Haz clic para copiar el precio al portapapeles";
          priceSpan.addEventListener("click", () => copyPriceToClipboard(row));

          const shareIcon = document.createElement("i");
          shareIcon.className = "fas fa-share-alt share-icon";
          shareIcon.title = "Compartir por WhatsApp";
          shareIcon.addEventListener("click", () => showWhatsappModal(row));

          priceContainer.appendChild(priceSpan);
          priceContainer.appendChild(shareIcon);
          tdVenta.appendChild(priceContainer);
        }

        tr.appendChild(tdVenta);
        tbody.appendChild(tr);
      });

      updateResultsCount();
    }

    function updateResultsCount() {
      const countEl = document.getElementById("resultsCount");
      const total = allData.length;
      const shown = filteredData.length;

      if (shown > 0) {
        countEl.textContent = `${shown} resultado${shown !== 1 ? "s" : ""}`;
        // Si quieres "X de Y", cambia la linea de arriba por:
        // countEl.textContent = `${shown} de ${total} resultados`;
        countEl.style.display = "block";
      } else {
        countEl.style.display = "none";
      }
    }

    function handleEdit(e) {
      const input = e.target;
      const rowId = input.getAttribute("data-id");
      const field = input.getAttribute("data-field");
      let value = input.value;

      if (field === "precio_compra" || field === "precio_venta") {
        value = Math.round(parseFloat(value) || 0);
        input.value = value;
      }

      saveEditToStorage(rowId, field, value);
      updateDataInMemory(rowId, field, value);
    }

    function saveEditToStorage(rowId, field, value) {
      const edits = JSON.parse(localStorage.getItem("priceListEdits") || "{}");
      if (!edits[rowId]) edits[rowId] = {};
      edits[rowId][field] = value;
      localStorage.setItem("priceListEdits", JSON.stringify(edits));
      showStatus("‚úÖ Precio actualizado correctamente", "success");
    }

    function loadEditsFromStorage() {
      const edits = JSON.parse(localStorage.getItem("priceListEdits") || "{}");
      allData.forEach(row => {
        const rowId = generateRowId(row);
        if (edits[rowId]) {
          if (edits[rowId].precio_venta !== undefined) row.precio_venta = edits[rowId].precio_venta;
          if (edits[rowId].precio_compra !== undefined) row.precio_compra = edits[rowId].precio_compra;
        }
      });
    }

    function updateDataInMemory(rowId, field, value) {
      const [lista, marca, modelo, tipo, proveedor, precio_compra] = rowId.split("|");
      allData.forEach(row => {
        if (
          row.lista === lista &&
          row.marca === marca &&
          row.modelo === modelo &&
          row.tipo === tipo &&
          row.proveedor === proveedor &&
          row.precio_compra == precio_compra
        ) {
          if (field === "precio_compra" || field === "precio_venta") {
            row[field] = Math.round(parseFloat(value) || 0);
          }
        }
      });
      applyFilters();
    }

    function showAdminModal() {
      document.getElementById("adminModal").style.display = "flex";
      document.getElementById("adminPassword").focus();
    }
    function hideAdminModal() {
      document.getElementById("adminModal").style.display = "none";
      document.getElementById("adminPassword").value = "";
    }

    function showEditModal() {
      document.getElementById("editModal").style.display = "flex";
      document.getElementById("editPassword").focus();
    }
    function hideEditModal() {
      document.getElementById("editModal").style.display = "none";
      document.getElementById("editPassword").value = "";
    }

    function showProvidersModal() {
      document.getElementById("providersModal").style.display = "flex";
      document.getElementById("providersPassword").focus();
    }
    function hideProvidersModal() {
      document.getElementById("providersModal").style.display = "none";
      document.getElementById("providersPassword").value = "";
    }

    function showVentaModal() {
      document.getElementById("ventaModal").style.display = "flex";
      document.getElementById("ventaPassword").focus();
    }
    function hideVentaModal() {
      document.getElementById("ventaModal").style.display = "none";
      document.getElementById("ventaPassword").value = "";
    }

    function showWhatsappModal(row) {
      currentWhatsappRow = row;
      const message = generateWhatsappMessage(row);
      document.getElementById("whatsappMessage").textContent = message;
      document.getElementById("whatsappModal").style.display = "flex";
    }
    function hideWhatsappModal() {
      document.getElementById("whatsappModal").style.display = "none";
      currentWhatsappRow = null;
    }

    function hideCompareModal() {
      document.getElementById("compareModal").style.display = "none";
    }

    function generateWhatsappMessage(row) {
      return `üì± *PRECIO DE PANTALLA* ${row.marca} ${row.modelo}\nPrecio: ${formatCurrency(row.precio_venta)} Bs.`;
    }

    function handleWhatsappShare() {
      if (!currentWhatsappRow) return;
      const message = generateWhatsappMessage(currentWhatsappRow);
      const encodedMessage = encodeURIComponent(message);
      window.open(`https://wa.me/?text=${encodedMessage}`, "_blank");
      hideWhatsappModal();
      showStatus("‚úÖ Mensaje preparado para WhatsApp", "success");
    }

    function handleAdminAccess() {
      const password = document.getElementById("adminPassword").value;
      if (password === ADMIN_PASSWORD) {
        showStatus("‚úÖ Acceso administrativo concedido", "success");
        hideAdminModal();
      } else {
        showStatus("‚ùå Clave incorrecta. Intente nuevamente.", "error");
        document.getElementById("adminPassword").value = "";
        document.getElementById("adminPassword").focus();
      }
    }

    function handleEditAccess() {
      const password = document.getElementById("editPassword").value;
      if (password === EDIT_PASSWORD) {
        editMode = true;
        hideEditModal();
        updateEditModeUI();
        showStatus("‚úÖ Modo edici√≥n activado", "success");
      } else {
        showStatus("‚ùå Clave incorrecta. Intente nuevamente.", "error");
        document.getElementById("editPassword").value = "";
        document.getElementById("editPassword").focus();
      }
    }

    function handleProvidersAccess() {
      const password = document.getElementById("providersPassword").value;
      if (password === PROVIDERS_PASSWORD) {
        providersAccess = true;
        showProviders = true;
        hideProvidersModal();
        updateProvidersUI();
        updateTableColumns();
        applyFilters();
        showStatus("‚úÖ Acceso a importadoras activado", "success");
      } else {
        showStatus("‚ùå Clave incorrecta. Intente nuevamente.", "error");
        document.getElementById("providersPassword").value = "";
        document.getElementById("providersPassword").focus();
      }
    }

    function handleVentaAccess() {
      const password = document.getElementById("ventaPassword").value;
      if (password === VENTA_PASSWORD) {
        ventaEditMode = true;
        hideVentaModal();
        showStatus("‚úÖ Puede editar el precio de venta", "success");
        renderTable();
      } else {
        showStatus("‚ùå Clave incorrecta. Intente nuevamente.", "error");
        document.getElementById("ventaPassword").value = "";
        document.getElementById("ventaPassword").focus();
      }
    }

    function updateEditModeUI() {
      const editNotice = document.getElementById("editNotice");
      if (editMode) editNotice.style.display = "block";
      else editNotice.style.display = "none";
      renderTable();
    }

    function verifyDataIntegrity() {
      const issues = [];

      const ventaMenor = allData.filter(item => item.precio_venta < item.precio_compra);
      if (ventaMenor.length > 0) issues.push(`${ventaMenor.length} con venta < compra`);

      const precioCero = allData.filter(item => item.precio_venta === 0 || item.precio_compra === 0);
      if (precioCero.length > 0) issues.push(`${precioCero.length} con precios cero`);

      const desconocidos = allData.filter(item => item.marca.includes("Desconocido") || item.modelo.includes("Desconocido"));
      if (desconocidos.length > 0) issues.push(`${desconocidos.length} con datos incompletos`);

      if (issues.length) console.log("Problemas de datos:", issues.join(" | "));
      return issues;
    }
  </script>
</body>
</html>
